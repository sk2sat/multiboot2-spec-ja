### 3.1 OSイメージのフォーマット

OSイメージは，特定のオペレーティングシステムのための通常の32bit実行可能ファイルですが，
PCのI/O領域やその他の予約された領域上にロードされることを避けるために，デフォルト以外のロードアドレスでリンクされます．
もちろん，共有ライブラリやその他の奇特な機能を使用するべきではありません．


OSイメージは，OSイメージで使用される形式のヘッダの他に，**マルチブート2ヘッダ**と呼ばれる追加のヘッダを含む必要があります．
マルチブート2ヘッダは，OSイメージの最初の32768バイト以内に完全に含まれている必要があり，
かつ，64bitでアラインされている必要があります．
一般に，このヘッダは***可能な限り早く***配置されるべきであり，
***実際の***実行可能フォーマットのヘッダの後のテキストセグメントの先頭に埋め込まれるかもしれません．

#### 3.1.1 マルチブート2ヘッダのレイアウト

マルチブート2ヘッダのレイアウトは，次のようにする必要があります．

| オフセット | 型 |    領域名    | 備考 |
|:-----------|:---|:-------------|:-----|
|  0         |u32 |マジック      | 必須 |
|  4         |u32 |アーキテクチャ| 必須 |
|  8         |u32 |ヘッダ長      | 必須 |
| 12         |u32 |チェックサム  | 必須 |
| 16-XX      |    |タグ          | 必須 |

フィールド「マジック」，「アーキテクチャ」，「ヘッダ長」は
[ヘッダマジック領域](#3.1.2 マルチブート2ヘッダのマジック領域)
「タグ」は
[ヘッダダグ](#3.1.3 一般的なタグの構造)
で定義されています．
全ての領域はネイティブのエンディアンになっています．
バイエンディアンプラットフォームでは，ネイティブのエンディアンとはOSイメージが開始するエンディアンを意味します．

#### 3.1.2 マルチブート2ヘッダのマジック領域
- magic
```
magicはヘッダを識別するマジックナンバーで，これは16進値で0xE85250D6である必要があります．
```

- architecture
```
architectureはCPUの命令セットアーキテクチャを指定します．
magicでエンディアンが指定されているので，エンディアンのみが異なるISAは同じIDとなります．
'0'は32bitの(プロテクトモードの)i386，'4'は32bitのMIPSを意味します．
```

- header_length
```
マジック領域も含めたマルチブート2ヘッダの長さをバイト単位で指定します．
```

- checksum
```
checksumは32bitの符号なしの値で，
他のマジック領域(magic，architecture，header_lengthなど)
と加算した時，32bitの符号なしの合計がゼロになる必要があります．  
checksum = - (magic + architecture + header_length)
```

#### 3.1.3 一般的なタグの構造

タグは，各タグが8バイトでアラインされたアドレスで開始するために，必要に応じてそれぞれがパディングされた構造体を構成します．
タグは，type=0,size=8のタグで終了します．
全ての構造体は次の形式をとります．

|:-:|:---:|
|u16|type |
|u16|flags|
|u32|size |

typeは2つのパートに分かれています．
下位8bitは残りのタグの内容の識別子を含みます．
sizeにはヘッダ領域を含むタグのサイズが含まれます．
flagsの0bit目(optionalとも呼ばれます)がセットされている時，
ブートローダは関連するサポートが無い限りこのタグを無視するでしょう．
タグはtype=0,size=8で終了します．
